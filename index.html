<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lusungulo Fresh Broilers - PWA</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#2e7d32">
<link rel="manifest" href="data:application/manifest+json,{
  &quot;name&quot;: &quot;Lusungulo Fresh Broilers&quot;,
  &quot;short_name&quot;: &quot;Lusungulo&quot;,
  &quot;start_url&quot;: &quot;.&quot;,
  &quot;display&quot;: &quot;standalone&quot;,
  &quot;background_color&quot;: &quot;#2e7d32&quot;,
  &quot;theme_color&quot;: &quot;#2e7d32&quot;,
  &quot;icons&quot;: [{
    &quot;src&quot;: &quot;https://i.imgur.com/4xM5Z5H.png&quot;,
    &quot;sizes&quot;: &quot;192x192&quot;,
    &quot;type&quot;: &quot;image/png&quot;
  }]
}">

<!-- FontAwesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- SweetAlert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
* {
  box-sizing: border-box;
}
body{
  font-family:Arial, sans-serif;
  background:linear-gradient(135deg,#f5f5f5 0%,#e8f5e9 100%);
  margin:0;
  padding:10px;
  color:#333;
}
.app{
  max-width:550px;
  margin:auto;
  background:white;
  border-radius:15px;
  box-shadow:0 5px 20px rgba(0,0,0,.2);
  overflow:hidden;
  padding-bottom:20px;
}
header{
  background:#2e7d32;
  color:white;
  padding:15px;
  text-align:center;
}
header h2{margin-bottom:5px;}
header p{font-size:14px;}
.offline-badge {
  background:#ff6f00;
  color:white;
  padding:5px 10px;
  border-radius:20px;
  display:inline-block;
  margin-top:5px;
  font-size:12px;
}
.stock-badge {
  background:#ff6f00;
  color:white;
  padding:8px 15px;
  border-radius:20px;
  display:inline-block;
  margin-top:5px;
  font-weight:bold;
}
.special-deal {
  background: linear-gradient(45deg,#ff9a9e,#fad0c4);
  color:white;
  padding:12px;
  text-align:center;
  border-radius:12px;
  font-weight:bold;
  margin:10px 15px;
  box-shadow:0 5px 15px rgba(0,0,0,0.2);
  animation: pulse 1.5s infinite;
}
@keyframes pulse{
  0%,100%{transform:scale(1);}
  50%{transform:scale(1.05);}
}
.section{padding:15px;}
input,select,textarea{
  width:100%;
  padding:10px;
  margin-top:8px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:16px;
  box-sizing: border-box;
}
button{
  padding:12px;
  margin-top:12px;
  width:100%;
  border:none;
  border-radius:10px;
  background:#4caf50;
  color:white;
  font-size:16px;
  cursor:pointer;
  font-weight:bold;
  transition: all 0.3s;
}
button:hover{background:#388e3c;}
.btn-warning{
  background:#ff9800;
}
.btn-warning:hover{background:#f57c00;}
.btn-danger{
  background:#f44336;
}
.btn-danger:hover{background:#d32f2f;}
.btn-info{
  background:#2196f3;
}
.btn-info:hover{background:#1976d2;}
.btn-success{
  background:#4caf50;
}
.btn-secondary{
  background:#9e9e9e;
}
.notice{
  background:#c8e6c9;
  padding:10px;
  border-left:5px solid green;
  margin:10px 0;
  font-size:14px;
}
#receipt,#adminPanel,#trackingPanel,#stockPanel,#customerPanel,#ratingsPanel{display:none;}
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
}
.modal-box{
  background:white;
  padding:20px;
  border-radius:10px;
  text-align:center;
  max-width:90%;
  max-height:90vh;
  overflow-y:auto;
}
img.option-img{
  width:100%;
  border-radius:10px;
  margin-top:10px;
}
.price-box{
  background:#fff3e0;
  padding:10px;
  margin-top:10px;
  border-left:5px solid #fb8c00;
  font-weight:bold;
  text-align:center;
  font-size:18px;
  transition: transform 0.2s;
}
.menu-card{
  border-radius:15px;
  overflow:hidden;
  box-shadow:0 10px 25px rgba(0,0,0,.2);
  margin-bottom:15px;
  transition: transform 0.3s, box-shadow 0.3s;
  text-align:center;
  background:white;
  cursor:pointer;
  position:relative;
}
.menu-card img{width:100%;height:200px;object-fit:cover;}
.menu-card:hover{
  transform:scale(1.03);
  box-shadow:0 15px 30px rgba(0,0,0,.3);
}
.menu-card h4{color:#2e7d32;margin:10px 0;}
.menu-card p{font-weight:bold;color:#fb8c00;font-size:18px;}
.stock-indicator{
  position:absolute;
  top:10px;
  right:10px;
  background:rgba(0,0,0,0.7);
  color:white;
  padding:5px 10px;
  border-radius:20px;
  font-size:12px;
}
.low-stock{
  background:#ff9800;
}
.out-stock{
  background:#f44336;
}
.in-stock{
  background:#4caf50;
}
.icon-input{
  display:flex;
  align-items:center;
  margin-top:8px;
}
.icon-input i{
  margin-right:8px;
  color:#2e7d32;
  min-width:20px;
}
.icon-input input, .icon-input select, .icon-input textarea {
  flex: 1;
}
#qty {
  width: 100%;
  padding: 10px;
  margin-top: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 16px;
  box-sizing: border-box;
}
.tracking-step {
  display: flex;
  margin-bottom: 15px;
  padding: 10px;
  background: #f5f5f5;
  border-radius: 10px;
}
.tracking-step .step-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #ddd;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 15px;
  color: white;
}
.step-completed .step-icon {
  background: #4caf50;
}
.step-active .step-icon {
  background: #ff9800;
  animation: pulse 1.5s infinite;
}
.step-content {
  flex: 1;
}
.step-status {
  font-weight: bold;
}
.status-pending{color:#ff9800;}
.status-processing{color:#2196f3;}
.status-ready{color:#4caf50;}
.status-delivered{color:#9c27b0;}
.order-card {
  background: white;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  border-left: 5px solid #ff9800;
}
.order-card h4 {
  margin-top: 0;
  color: #2e7d32;
}
.stock-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid #eee;
}
.stock-control {
  display: flex;
  align-items: center;
  gap: 10px;
}
.stock-control button {
  width: auto;
  padding: 5px 15px;
  margin: 0;
}
.tabs {
  display: flex;
  margin-bottom: 20px;
  border-bottom: 2px solid #eee;
  flex-wrap: wrap;
}
.tab {
  flex: 1;
  padding: 10px;
  text-align: center;
  cursor: pointer;
  background: #f5f5f5;
  border: none;
  border-radius: 0;
  margin: 0;
  min-width: 100px;
}
.tab.active {
  background: #4caf50;
  color: white;
}
.tab-content {
  display: none;
}
.tab-content.active {
  display: block;
}
.payment-option {
  display: flex;
  align-items: center;
  padding: 15px;
  border: 2px solid #ddd;
  border-radius: 10px;
  margin: 10px 0;
  cursor: pointer;
  transition: all 0.3s;
}
.payment-option.selected {
  border-color: #4caf50;
  background: #e8f5e9;
}
.payment-option i {
  font-size: 24px;
  margin-right: 15px;
  color: #2e7d32;
}
.rating {
  display: flex;
  flex-direction: row-reverse;
  justify-content: center;
  gap: 5px;
  margin: 15px 0;
}
.rating input {
  display: none;
}
.rating label {
  font-size: 30px;
  color: #ddd;
  cursor: pointer;
}
.rating label:hover,
.rating label:hover ~ label,
.rating input:checked ~ label {
  color: #ffc107;
}
.customer-card {
  background: white;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  border-left: 5px solid #2196f3;
}
.rating-display {
  color: #ffc107;
  font-size: 18px;
}
.install-button {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #2e7d32;
  color: white;
  border-radius: 50px;
  padding: 15px 25px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
  z-index: 1000;
  display: none;
  cursor: pointer;
  border: none;
  width: auto;
}
@media (display-mode: standalone) {
  .install-button {
    display: none !important;
  }
}
.filters {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}
.filters button {
  flex: 1;
  margin: 0;
  padding: 8px;
  font-size: 14px;
}
/* ADMIN AUTHENTICATION */
.admin-login {
  background: #f5f5f5;
  padding: 20px;
  border-radius: 10px;
  margin-bottom: 20px;
}
.admin-content {
  display: none;
}
.admin-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.admin-logout {
  background: #f44336;
  width: auto;
  padding: 8px 15px;
  margin: 0;
}
</style>
</head>
<body>

<!-- INSTALL APP BUTTON -->
<button id="installButton" class="install-button">
  <i class="fa-solid fa-download"></i> INSTALL APP
</button>

<div class="app">
<header>
<h2>üêî Lusungulo Fresh Broilers</h2>
<p>Fresh, Delicious & Ready for You!</p>
<div id="offlineStatus" class="offline-badge" style="display:none;">üì¥ OFFLINE MODE</div>
<div class="stock-badge" id="totalStockDisplay">Loading stock...</div>
</header>

<div class="special-deal">üéâ SPECIAL DEAL: Buy 2 Medium Chickens, Get 1 Small FREE! üéâ</div>

<!-- Tabs - Customer View (No Admin Tab Visible to Public) -->
<div class="tabs">
  <button class="tab active" onclick="switchTab('customer')">üõí ORDER</button>
  <button class="tab" onclick="switchTab('track')">üìç TRACK</button>
  <button class="tab" onclick="switchTab('rate')">‚≠ê RATE</button>
  <button class="tab" onclick="switchTab('customers')">üë• REVIEWS</button>
</div>

<!-- CUSTOMER TAB -->
<div id="customerTab" class="tab-content active">
<div class="section">
<div class="notice">
<i class="fa-solid fa-lock"></i> üîê E50 refundable deposit required for MoMo payments
</div>

<form id="orderForm">

<div class="icon-input">
  <i class="fa-solid fa-user"></i>
  <input id="name" placeholder="Full Name" required>
</div>
<div class="icon-input">
  <i class="fa-solid fa-phone"></i>
  <input id="phone" placeholder="Phone Number" required>
</div>
<div class="icon-input">
  <i class="fa-solid fa-id-card"></i>
  <input id="idNumber" placeholder="National ID Number" required>
</div>
<div class="icon-input">
  <i class="fa-solid fa-house"></i>
  <input id="address" placeholder="Delivery Address" required>
</div>

<h4>üêî Available Birds in Stock</h4>
<div id="liveStockDisplay"></div>

<h4>üêî Select Size</h4>
<div id="sizeCards"></div>

<select id="size" required style="display:none;">
<option value="">Select Size</option>
<option value="1.5">Small (1.5 kg)</option>
<option value="2.0">Medium (2 kg)</option>
<option value="2.5">Large (2.5 kg)</option>
</select>

<h4>üì¶ Quantity</h4>
<input type="number" id="qty" placeholder="Quantity" value="1" min="1" required>

<h4>üçó Select Type</h4>
<select id="type" required>
<option value="">Select Type</option>
<option value="full">Full Chicken</option>
<option value="cut">Cut Pieces</option>
</select>

<img id="fullImg" class="option-img" src="https://images.unsplash.com/photo-1604908177524-9f409a8b3d95?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&h=200&w=400" style="display:none;" alt="Full Chicken">
<img id="cutImg" class="option-img" src="https://images.unsplash.com/photo-1601050692362-9f90f13ee824?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&h=200&w=400" style="display:none;" alt="Cut Pieces">

<div id="services" style="display:none;">
<h4>üç¥ Select Service (Full Chicken Only)</h4>
<select id="service">
<option value="">No Service</option>
<option value="5">Ready to Cook + E5</option>
<option value="10">Curry Cut + E10</option>
</select>
<img id="serviceImg" class="option-img" style="display:none;" alt="Service Image">
</div>

<h4>üí≥ Payment Method</h4>
<div id="paymentOptions">
  <div class="payment-option" onclick="selectPayment('momo')" id="paymentMomo">
    <i class="fa-solid fa-mobile-alt"></i>
    <div style="flex:1; text-align:left;">
      <strong>MoMo (Mobile Money)</strong><br>
      <small>Pay E50 deposit via Mobile Money</small>
    </div>
    <i class="fa-solid fa-check-circle" id="checkMomo" style="color:#4caf50; display:none;"></i>
  </div>
  <div class="payment-option" onclick="selectPayment('cash')" id="paymentCash">
    <i class="fa-solid fa-money-bill-wave"></i>
    <div style="flex:1; text-align:left;">
      <strong>Cash on Delivery</strong><br>
      <small>Pay full amount when order arrives</small>
    </div>
    <i class="fa-solid fa-check-circle" id="checkCash" style="color:#4caf50; display:none;"></i>
  </div>
</div>
<input type="hidden" id="paymentMethod" value="momo">

<div id="momoFields">
  <h4>üí≥ MoMo Payment Details</h4>
  <div class="icon-input">
    <i class="fa-solid fa-calendar"></i>
    <input type="date" id="payDate" required>
  </div>
  <div class="icon-input">
    <i class="fa-solid fa-clock"></i>
    <input type="time" id="payTime" required>
  </div>
  <div class="icon-input">
    <i class="fa-solid fa-user"></i>
    <input id="momoName" placeholder="Your Name as Registered in MoMo">
  </div>
</div>

<div id="cashFields" style="display:none;">
  <h4>üíµ Cash on Delivery</h4>
  <div class="notice">
    <i class="fa-solid fa-info-circle"></i> Pay full amount E<span id="cashTotal">0</span> when your order arrives
  </div>
</div>

<div class="price-box">Total Price: <span id="totalPrice">0</span> E</div>

<button type="submit">üì± PLACE ORDER</button>
</form>

<button onclick="switchTab('track')" class="btn-info">üìç TRACK YOUR ORDER</button>
</div>

<!-- RECEIPT -->
<div id="receipt" class="section">
<h3>üßæ ORDER RECEIPT</h3>
<p id="rName"></p>
<p id="rPhone"></p>
<p id="rOrder"></p>
<p id="rDeposit"></p>
<p id="rTotal"></p>
<p id="rPayment"></p>
<p id="rMomoName"></p>
<p id="rTracking"></p>
<button onclick="window.print()">üñ® Print Receipt</button>
<button onclick="switchTab('track')" class="btn-info">üìç Track Order</button>
<button onclick="switchTab('rate')" class="btn-warning">‚≠ê Rate Your Order</button>
</div>
</div>

<!-- TRACKING TAB -->
<div id="trackTab" class="tab-content">
<div class="section">
<h3>üìç TRACK YOUR ORDER</h3>
<div class="icon-input">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input id="trackPhone" placeholder="Enter your phone number">
</div>
<button onclick="trackOrder()">üîç TRACK ORDER</button>

<div id="trackingResult" style="margin-top:20px;"></div>
</div>
</div>

<!-- RATING TAB -->
<div id="rateTab" class="tab-content">
<div class="section">
<h3>‚≠ê RATE & REVIEW</h3>
<div class="icon-input">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input id="ratePhone" placeholder="Enter your phone number to review">
</div>
<button onclick="loadOrdersForRating()">üîç FIND MY ORDERS</button>

<div id="ordersForRating" style="margin-top:20px;"></div>
</div>
</div>

<!-- CUSTOMERS REVIEWS TAB - PUBLIC ONLY SEES REVIEWS, NO REVENUE DATA -->
<div id="customersTab" class="tab-content">
<div class="section">
<h3>üë• CUSTOMER REVIEWS</h3>
<div class="filters">
  <button onclick="loadPublicReviews('all')" class="btn-info">‚≠ê ALL REVIEWS</button>
  <button onclick="loadPublicReviews('high')" class="btn-success">üåüüåüüåüüåüüåü</button>
  <button onclick="loadPublicReviews('low')" class="btn-warning">‚≠ê‚≠ê‚≠ê</button>
</div>
<div id="publicReviewsList"></div>
</div>
</div>

<!-- ADMIN SECTION - HIDDEN FROM PUBLIC, REQUIRES PASSWORD -->
<div id="adminSection" style="display:none; padding:15px; margin-top:20px; border-top:2px solid #2e7d32;">
  <div class="admin-header">
    <h3>üëë ADMIN PANEL</h3>
    <button onclick="logoutAdmin()" class="admin-logout">üö™ LOGOUT</button>
  </div>
  
  <!-- Stock Management - ONLY ADMIN CAN SEE AND EDIT -->
  <div style="background:#e8f5e9; padding:15px; border-radius:10px; margin-bottom:20px;">
    <h4>üì¶ MANAGE INVENTORY</h4>
    <div id="stockManagement"></div>
    <button onclick="showAddStockModal()" class="btn-info">‚ûï ADD NEW BATCH</button>
    <button onclick="showAdjustStockModal()" class="btn-warning">‚úèÔ∏è ADJUST STOCK</button>
  </div>

  <!-- Customer Database - ADMIN ONLY -->
  <div style="background:#e3f2fd; padding:15px; border-radius:10px; margin-bottom:20px;">
    <h4>üë• CUSTOMER DATABASE</h4>
    <div id="customerStats"></div>
    <button onclick="exportCustomers()" class="btn-info">üìä EXPORT CUSTOMERS</button>
  </div>

  <!-- Order Management - ADMIN ONLY -->
  <h4>üìã ALL ORDERS</h4>
  <div id="ordersList"></div>

  <button onclick="exportOrders()" class="btn-info">üìä EXPORT ORDERS</button>
  <button onclick="exportRatings()" class="btn-info">‚≠ê EXPORT RATINGS</button>
</div>

<!-- ADMIN LOGIN BUTTON - HIDDEN BUTTON TO ACCESS ADMIN -->
<div style="text-align:center; margin-top:20px; padding:10px;">
  <button onclick="showAdminLogin()" style="background:#9e9e9e; width:auto; padding:8px 20px;">üëë ADMIN LOGIN</button>
</div>

</div>

<!-- ADD STOCK MODAL - ADMIN ONLY -->
<div id="addStockModal" class="modal">
  <div class="modal-box">
    <h3>‚ûï ADD NEW BATCH</h3>
    <select id="stockSize">
      <option value="1.5">Small (1.5kg)</option>
      <option value="2.0">Medium (2kg)</option>
      <option value="2.5">Large (2.5kg)</option>
    </select>
    <input type="number" id="stockQuantity" placeholder="Quantity to Add" min="1">
    <input type="number" id="stockPrice" placeholder="Price per kg" value="45">
    <button onclick="addStock()" style="background:#4caf50;">ADD TO INVENTORY</button>
    <button onclick="closeModal()" style="background:#f44336;">CANCEL</button>
  </div>
</div>

<!-- ADJUST STOCK MODAL - ADMIN ONLY -->
<div id="adjustStockModal" class="modal">
  <div class="modal-box">
    <h3>‚úèÔ∏è ADJUST STOCK</h3>
    <select id="adjustSize">
      <option value="1.5">Small (1.5kg)</option>
      <option value="2.0">Medium (2kg)</option>
      <option value="2.5">Large (2.5kg)</option>
    </select>
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="adjustStockFromModal(-1)" class="btn-warning" style="flex:1;">-1</button>
      <button onclick="adjustStockFromModal(-5)" class="btn-warning" style="flex:1;">-5</button>
      <button onclick="adjustStockFromModal(-10)" class="btn-warning" style="flex:1;">-10</button>
    </div>
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="adjustStockFromModal(1)" class="btn-success" style="flex:1;">+1</button>
      <button onclick="adjustStockFromModal(5)" class="btn-success" style="flex:1;">+5</button>
      <button onclick="adjustStockFromModal(10)" class="btn-success" style="flex:1;">+10</button>
    </div>
    <input type="number" id="customAdjust" placeholder="Custom quantity" min="1">
    <div style="display:flex; gap:10px; margin-top:10px;">
      <button onclick="adjustStockFromModal(parseInt(document.getElementById('customAdjust').value) || 0)" class="btn-info" style="flex:1;">Apply</button>
      <button onclick="closeAdjustModal()" style="background:#f44336; flex:1;">CANCEL</button>
    </div>
  </div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div id="adminLoginModal" class="modal">
  <div class="modal-box">
    <h3>üëë ADMIN LOGIN</h3>
    <input type="password" id="adminPassword" placeholder="Enter Admin Password">
    <button onclick="verifyAdmin()" style="background:#4caf50;">LOGIN</button>
    <button onclick="closeLoginModal()" style="background:#f44336;">CANCEL</button>
    <p style="margin-top:15px; font-size:12px; color:#666;">Default password: admin123</p>
  </div>
</div>

<!-- RATING MODAL -->
<div id="ratingModal" class="modal">
  <div class="modal-box">
    <h3>‚≠ê RATE YOUR ORDER</h3>
    <div id="ratingOrderDetails"></div>
    
    <div class="rating">
      <input type="radio" name="rating" id="star5" value="5"><label for="star5">‚òÖ</label>
      <input type="radio" name="rating" id="star4" value="4"><label for="star4">‚òÖ</label>
      <input type="radio" name="rating" id="star3" value="3"><label for="star3">‚òÖ</label>
      <input type="radio" name="rating" id="star2" value="2"><label for="star2">‚òÖ</label>
      <input type="radio" name="rating" id="star1" value="1"><label for="star1">‚òÖ</label>
    </div>
    
    <textarea id="reviewComment" placeholder="Write your review here..." rows="4"></textarea>
    
    <button onclick="submitRating()" style="background:#4caf50;">SUBMIT REVIEW</button>
    <button onclick="closeRatingModal()" style="background:#f44336;">CANCEL</button>
  </div>
</div>

<!-- CONFIRM DELIVERY MODAL -->
<div id="confirmModal" class="modal">
  <div class="modal-box">
    <h3>‚úÖ CONFIRM DELIVERY</h3>
    <p>Have you received your order?</p>
    <div id="confirmOrderDetails"></div>
    <button onclick="confirmDelivery()" style="background:#4caf50;">YES, I RECEIVED IT</button>
    <button onclick="closeConfirmModal()" style="background:#f44336;">CANCEL</button>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// üî•üî•üî• FIREBASE CONFIGURATION üî•üî•üî•
var firebaseConfig = {
  apiKey: "AIzaSyCXJeodZbNeGyLfJgQrqYriJVdgi-GOA1o",
  authDomain: "lusungulo-3a422.firebaseapp.com",
  databaseURL: "https://lusungulo-3a422-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "lusungulo-3a422",
  storageBucket: "lusungulo-3a422.firebasestorage.app",
  messagingSenderId: "644814725574",
  appId: "1:644814725574:web:cfbaa03a1ee7ba7e1e7ac7",
  measurementId: "G-E25HW7HNZ6"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
var db = firebase.database();

// ============ PWA OFFLINE SUPPORT ============
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('data:application/javascript,' + encodeURIComponent(`
      const CACHE_NAME = 'lusungulo-v1';
      const urlsToCache = [
        '.',
        'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css',
        'https://cdn.jsdelivr.net/npm/sweetalert2@11',
        'https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js',
        'https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js'
      ];

      self.addEventListener('install', event => {
        event.waitUntil(
          caches.open(CACHE_NAME)
            .then(cache => cache.addAll(urlsToCache))
        );
      });

      self.addEventListener('fetch', event => {
        event.respondWith(
          caches.match(event.request)
            .then(response => response || fetch(event.request))
        );
      });
    `)).then(() => {
      console.log('Service Worker registered');
    });
  });
}

// Online/Offline detection
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

function updateOnlineStatus() {
  const offlineBadge = document.getElementById('offlineStatus');
  if (navigator.onLine) {
    offlineBadge.style.display = 'none';
  } else {
    offlineBadge.style.display = 'inline-block';
  }
}

// Install PWA
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installButton').style.display = 'block';
});

document.getElementById('installButton').addEventListener('click', async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  console.log(`User response to the install prompt: ${outcome}`);
  deferredPrompt = null;
  document.getElementById('installButton').style.display = 'none';
});

// ============ ADMIN AUTHENTICATION ============
const ADMIN_PASSWORD = "admin123"; // Change this to your desired password

function showAdminLogin() {
  document.getElementById('adminLoginModal').style.display = 'flex';
}

function closeLoginModal() {
  document.getElementById('adminLoginModal').style.display = 'none';
  document.getElementById('adminPassword').value = '';
}

function verifyAdmin() {
  const password = document.getElementById('adminPassword').value;
  
  if (password === ADMIN_PASSWORD) {
    // Hide login modal
    closeLoginModal();
    
    // Show admin section
    document.getElementById('adminSection').style.display = 'block';
    
    // Load admin data
    loadStockManagement();
    loadAllOrders();
    loadCustomerStats();
    
    Swal.fire({
      icon: 'success',
      title: 'Login Successful',
      text: 'Welcome to Admin Panel',
      timer: 1500,
      showConfirmButton: false
    });
  } else {
    Swal.fire({
      icon: 'error',
      title: 'Access Denied',
      text: 'Incorrect password'
    });
  }
}

function logoutAdmin() {
  document.getElementById('adminSection').style.display = 'none';
  Swal.fire({
    icon: 'info',
    title: 'Logged Out',
    text: 'Admin session ended',
    timer: 1500,
    showConfirmButton: false
  });
}

// ============ GLOBAL VARIABLES ============
const YOUR_WHATSAPP_NUMBER = "26876123456"; // üî¥ REPLACE WITH YOUR ACTUAL WHATSAPP NUMBER
let currentRatingOrderId = null;

// ============ TAB SWITCHING ============
function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    
    if (tab === 'customer') {
        document.getElementById('customerTab').classList.add('active');
        document.querySelectorAll('.tab')[0].classList.add('active');
    } else if (tab === 'track') {
        document.getElementById('trackTab').classList.add('active');
        document.querySelectorAll('.tab')[1].classList.add('active');
    } else if (tab === 'rate') {
        document.getElementById('rateTab').classList.add('active');
        document.querySelectorAll('.tab')[2].classList.add('active');
    } else if (tab === 'customers') {
        document.getElementById('customersTab').classList.add('active');
        document.querySelectorAll('.tab')[3].classList.add('active');
        loadPublicReviews('all');
    }
}

// ============ PAYMENT METHOD SELECTION ============
function selectPayment(method) {
    document.getElementById('paymentMethod').value = method;
    
    document.getElementById('checkMomo').style.display = 'none';
    document.getElementById('checkCash').style.display = 'none';
    
    if (method === 'momo') {
        document.getElementById('paymentMomo').classList.add('selected');
        document.getElementById('paymentCash').classList.remove('selected');
        document.getElementById('checkMomo').style.display = 'block';
        document.getElementById('momoFields').style.display = 'block';
        document.getElementById('cashFields').style.display = 'none';
        
        document.getElementById('payDate').required = true;
        document.getElementById('payTime').required = true;
        document.getElementById('momoName').required = true;
    } else {
        document.getElementById('paymentCash').classList.add('selected');
        document.getElementById('paymentMomo').classList.remove('selected');
        document.getElementById('checkCash').style.display = 'block';
        document.getElementById('momoFields').style.display = 'none';
        document.getElementById('cashFields').style.display = 'block';
        
        document.getElementById('payDate').required = false;
        document.getElementById('payTime').required = false;
        document.getElementById('momoName').required = false;
    }
}

// ============ STOCK MANAGEMENT - CUSTOMER VIEW (ONLY SEES QUANTITY) ============
function initializeStock() {
    db.ref("stock").once("value", snap => {
        if (!snap.exists()) {
            const defaultStock = {
                "1.5": { weight: 1.5, quantity: 50, pricePerKg: 45, lastUpdated: new Date().toISOString() },
                "2.0": { weight: 2.0, quantity: 35, pricePerKg: 45, lastUpdated: new Date().toISOString() },
                "2.5": { weight: 2.5, quantity: 20, pricePerKg: 45, lastUpdated: new Date().toISOString() }
            };
            db.ref("stock").set(defaultStock);
        }
    });
}
initializeStock();

// CUSTOMER VIEW - ONLY SEES QUANTITY AVAILABLE, NO EDIT BUTTONS
function displayStock() {
    db.ref("stock").on("value", snap => {
        const stock = snap.val() || {};
        let totalBirds = 0;
        let html = '<div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-bottom:20px;">';
        
        ['1.5', '2.0', '2.5'].forEach(weight => {
            const item = stock[weight] || { quantity: 0, pricePerKg: 45 };
            totalBirds += parseInt(item.quantity) || 0;
            
            let stockClass = 'in-stock';
            let stockText = `${item.quantity || 0} available`;
            if (item.quantity <= 0) {
                stockClass = 'out-stock';
                stockText = 'OUT OF STOCK';
            } else if (item.quantity <= 10) {
                stockClass = 'low-stock';
                stockText = `Only ${item.quantity} left!`;
            }
            
            // CUSTOMER VIEW - ONLY SHOWS QUANTITY, NO EDIT CONTROLS
            html += `<div class="menu-card" onclick="if(parseInt('${item.quantity}')>0) selectSize('${weight}')" style="margin-bottom:0;">
                        <img src="https://images.unsplash.com/photo-1604908177524-9f409a8b3d95?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&h=200&w=400" alt="Chicken">
                        <div class="stock-indicator ${stockClass}">${stockText}</div>
                        <h4>${weight}kg</h4>
                        <p>E${item.pricePerKg || 45}/kg</p>
                    </div>`;
        });
        html += '</div>';
        
        document.getElementById('liveStockDisplay').innerHTML = html;
        document.getElementById('totalStockDisplay').innerHTML = `üêî Total Birds: ${totalBirds}`;
        updateSizeCards(stock);
    });
}
displayStock();

// CUSTOMER SIZE CARDS - ONLY SHOWS AVAILABILITY
function updateSizeCards(stock) {
    let html = '';
    ['1.5', '2.0', '2.5'].forEach(weight => {
        const item = stock[weight] || { quantity: 0, pricePerKg: 45 };
        const disabled = item.quantity <= 0 ? 'style="opacity:0.5; pointer-events:none;"' : '';
        const price = (weight * (item.pricePerKg || 45)).toFixed(2);
        
        html += `<div class="menu-card" onclick="document.getElementById('size').value='${weight}';updatePrice();" ${disabled}>
                    <img src="https://images.unsplash.com/photo-1604908177524-9f409a8b3d95?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&h=200&w=400" alt="${weight}kg Chicken">
                    <div class="stock-indicator ${item.quantity <= 0 ? 'out-stock' : (item.quantity <= 10 ? 'low-stock' : 'in-stock')}">
                        ${item.quantity <= 0 ? 'OUT OF STOCK' : (item.quantity + ' available')}
                    </div>
                    <h4>${weight}kg Chicken</h4>
                    <p>Price: E${price}</p>
                </div>`;
    });
    document.getElementById('sizeCards').innerHTML = html;
}

function selectSize(weight) {
    document.getElementById('size').value = weight;
    updatePrice();
    document.getElementById('orderForm').scrollIntoView({behavior: "smooth"});
}

// ============ ADMIN STOCK MANAGEMENT - ONLY ADMIN CAN EDIT ============
function loadStockManagement() {
    db.ref("stock").on("value", snap => {
        const stock = snap.val() || {};
        let html = '';
        
        ['1.5', '2.0', '2.5'].forEach(weight => {
            const item = stock[weight] || { quantity: 0, pricePerKg: 45 };
            html += `<div class="stock-item">
                        <div>
                            <strong>${weight}kg</strong><br>
                            <small>Price: E${item.pricePerKg}/kg</small>
                        </div>
                        <div>
                            <span style="font-size:18px; font-weight:bold;">${item.quantity || 0}</span> birds
                        </div>
                        <div class="stock-control">
                            <button onclick="adjustStock('${weight}', -1)" class="btn-warning" style="width:40px;">-</button>
                            <button onclick="adjustStock('${weight}', 1)" class="btn-success" style="width:40px; background:#4caf50;">+</button>
                            <button onclick="showSetPriceModal('${weight}', ${item.pricePerKg})" class="btn-info" style="width:60px;">Price</button>
                        </div>
                    </div>`;
        });
        
        document.getElementById('stockManagement').innerHTML = html;
    });
}

// ADMIN STOCK ADJUSTMENT FUNCTIONS
function adjustStock(size, change) {
    db.ref("stock/" + size).once("value", snap => {
        const current = snap.val() || { quantity: 0, weight: parseFloat(size), pricePerKg: 45 };
        const newQuantity = Math.max(0, (current.quantity || 0) + change);
        
        db.ref("stock/" + size).update({
            quantity: newQuantity,
            lastUpdated: new Date().toISOString()
        }).then(() => {
            Swal.fire('Success', `Stock ${change > 0 ? 'increased' : 'decreased'} by ${Math.abs(change)}`, 'success');
        });
    });
}

function showAddStockModal() {
    if (document.getElementById('adminSection').style.display !== 'block') {
        Swal.fire('Access Denied', 'Admin login required', 'error');
        return;
    }
    document.getElementById('addStockModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('addStockModal').style.display = 'none';
    document.getElementById('stockQuantity').value = '';
}

function showAdjustStockModal() {
    if (document.getElementById('adminSection').style.display !== 'block') {
        Swal.fire('Access Denied', 'Admin login required', 'error');
        return;
    }
    document.getElementById('adjustStockModal').style.display = 'flex';
}

function closeAdjustModal() {
    document.getElementById('adjustStockModal').style.display = 'none';
    document.getElementById('customAdjust').value = '';
}

function adjustStockFromModal(change) {
    if (change === 0) {
        Swal.fire('Error', 'Please enter a valid quantity', 'error');
        return;
    }
    const size = document.getElementById('adjustSize').value;
    adjustStock(size, change);
    closeAdjustModal();
}

function addStock() {
    const size = document.getElementById('stockSize').value;
    const quantity = parseInt(document.getElementById('stockQuantity').value);
    const price = parseFloat(document.getElementById('stockPrice').value);
    
    if (!quantity || quantity < 1) {
        Swal.fire('Error', 'Please enter valid quantity', 'error');
        return;
    }
    
    db.ref("stock/" + size).once("value", snap => {
        const current = snap.val() || { quantity: 0, weight: parseFloat(size), pricePerKg: 45 };
        const newQuantity = (current.quantity || 0) + quantity;
        
        db.ref("stock/" + size).set({
            weight: parseFloat(size),
            quantity: newQuantity,
            pricePerKg: price,
            lastUpdated: new Date().toISOString()
        }).then(() => {
            Swal.fire('Success', `Added ${quantity} birds to ${size}kg batch`, 'success');
            closeModal();
        });
    });
}

function showSetPriceModal(size, currentPrice) {
    Swal.fire({
        title: `Set price for ${size}kg`,
        input: 'number',
        inputValue: currentPrice,
        inputLabel: 'Price per kg (E)',
        showCancelButton: true,
        confirmButtonText: 'Save',
        preConfirm: (price) => {
            db.ref("stock/" + size).update({
                pricePerKg: parseFloat(price),
                lastUpdated: new Date().toISOString()
            }).then(() => {
                Swal.fire('Success', 'Price updated', 'success');
            });
        }
    });
}

// Update stock when order is placed
function updateStockAfterOrder(size, qty) {
    db.ref("stock/" + size).once("value", snap => {
        const current = snap.val() || { quantity: 0 };
        const newQuantity = Math.max(0, (current.quantity || 0) - qty);
        
        db.ref("stock/" + size).update({
            quantity: newQuantity,
            lastUpdated: new Date().toISOString()
        });
    });
}

// ============ ORDER MANAGEMENT ============
const form = document.getElementById("orderForm");
const receipt = document.getElementById("receipt");
const sizeSelect = document.getElementById("size");
const qtyInput = document.getElementById("qty");
const typeSelect = document.getElementById("type");
const serviceSelect = document.getElementById("service");
const totalBox = document.getElementById("totalPrice");
const fullImg = document.getElementById("fullImg");
const cutImg = document.getElementById("cutImg");
const servicesDiv = document.getElementById("services");

function updatePrice(){
    let weight = parseFloat(sizeSelect.value) || 0;
    let qty = parseInt(qtyInput.value) || 1;
    let service = parseInt(serviceSelect.value) || 0;
    
    db.ref("stock/" + sizeSelect.value).once("value", snap => {
        const stock = snap.val() || { pricePerKg: 45 };
        const pricePerKg = stock.pricePerKg || 45;
        let total = weight * pricePerKg * qty + service * qty;
        
        totalBox.style.transform = "scale(1.2)";
        setTimeout(()=>totalBox.style.transform = "scale(1)", 200);
        totalBox.innerText = total.toFixed(2);
        document.getElementById('cashTotal').innerText = total.toFixed(2);
    });
}

typeSelect.addEventListener("change", () => {
    if(typeSelect.value === "full"){
        fullImg.style.display = "block";
        cutImg.style.display = "none";
        servicesDiv.style.display = "block";
    } else if(typeSelect.value === "cut"){
        fullImg.style.display = "none";
        cutImg.style.display = "block";
        servicesDiv.style.display = "none";
        serviceSelect.value = "";
    } else {
        fullImg.style.display = "none";
        cutImg.style.display = "none";
        servicesDiv.style.display = "none";
        serviceSelect.value = "";
    }
    updatePrice();
});

sizeSelect.addEventListener("change", updatePrice);
qtyInput.addEventListener("input", updatePrice);
serviceSelect.addEventListener("change", () => {
    updatePrice();
    const serviceImg = document.getElementById("serviceImg");
    if(serviceSelect.value == "5"){ 
        serviceImg.src = "https://images.unsplash.com/photo-1617196037536-6c60bcf9c6b2?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&h=200&w=400"; 
        serviceImg.style.display = "block"; 
    } else if(serviceSelect.value == "10"){ 
        serviceImg.src = "https://images.unsplash.com/photo-1601050692362-9f90f13ee824?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&h=200&w=400"; 
        serviceImg.style.display = "block"; 
    } else { 
        serviceImg.style.display = "none"; 
    }
});

// Save customer to database (ADMIN ONLY VIEW)
function saveCustomer(customerData) {
    db.ref("customers/" + customerData.phone.replace(/\D/g, '')).once("value", snap => {
        const existing = snap.val();
        const orders = existing ? (existing.orders || 0) + 1 : 1;
        const totalSpent = existing ? (parseFloat(existing.totalSpent) + parseFloat(customerData.total)) : parseFloat(customerData.total);
        
        db.ref("customers/" + customerData.phone.replace(/\D/g, '')).set({
            name: customerData.name,
            phone: customerData.phone,
            idNumber: customerData.idNumber,
            address: customerData.address,
            orders: orders,
            totalSpent: totalSpent.toFixed(2),
            lastOrder: new Date().toISOString(),
            firstOrder: existing ? existing.firstOrder : new Date().toISOString()
        });
    });
}

// Form submit
form.addEventListener("submit", function(e){
    e.preventDefault();
    
    let name = document.getElementById("name").value;
    let phone = document.getElementById("phone").value;
    let idNumber = document.getElementById("idNumber").value;
    let address = document.getElementById("address").value;
    let size = sizeSelect.value;
    let qty = parseInt(qtyInput.value) || 1;
    let type = typeSelect.value;
    let service = serviceSelect.value || 0;
    let paymentMethod = document.getElementById("paymentMethod").value;
    let payDate = document.getElementById("payDate").value;
    let payTime = document.getElementById("payTime").value;
    let momoName = document.getElementById("momoName").value;
    
    if (!size) {
        Swal.fire('Error', 'Please select a chicken size!', 'error');
        return;
    }
    
    if (paymentMethod === 'momo' && !momoName) {
        Swal.fire('Error', 'Please enter your name as registered in MoMo!', 'error');
        return;
    }
    
    db.ref("stock/" + size).once("value", snap => {
        const stock = snap.val() || { quantity: 0, pricePerKg: 45 };
        
        if (stock.quantity < qty) {
            Swal.fire('Sorry', `Only ${stock.quantity} birds available in this size`, 'error');
            return;
        }
        
        let total = (parseFloat(size) * (stock.pricePerKg || 45) * qty) + (parseInt(service) * qty);
        let trackingNumber = 'LS' + Date.now().toString().slice(-8);
        
        let order = {
            name, phone, idNumber, address, size, qty, type, 
            service: parseInt(service), 
            paymentMethod: paymentMethod,
            payDate: paymentMethod === 'momo' ? payDate : '',
            payTime: paymentMethod === 'momo' ? payTime : '',
            momoName: paymentMethod === 'momo' ? momoName : '',
            total: total.toFixed(2),
            trackingNumber: trackingNumber,
            status: 'pending',
            confirmed: false,
            statusHistory: [
                { status: 'pending', timestamp: new Date().toISOString(), note: 'Order received' }
            ],
            timestamp: new Date().toISOString()
        };

        db.ref("orders").push(order).then(() => {
            updateStockAfterOrder(size, qty);
            saveCustomer(order);
            
            Swal.fire({
                icon: 'success',
                title: 'Order Placed!',
                text: `Your tracking number is: ${trackingNumber}`
            });
            
            if (navigator.onLine) {
                let msg = `üêî *NEW ORDER - Lusungulo Fresh Broilers*
                
üë§ *CUSTOMER DETAILS*
Name: ${name}
Phone: ${phone}
ID: ${idNumber}
Address: ${address}

üì¶ *ORDER DETAILS*
Tracking #: ${trackingNumber}
Size: ${size}kg
Quantity: ${qty}
Type: ${type === "full" ? "Full Chicken" : "Cut Pieces"}
${service > 0 ? `Service: +E${service} each` : ''}

üí∞ *PAYMENT DETAILS*
Method: ${paymentMethod === 'momo' ? 'MoMo (E50 deposit)' : 'Cash on Delivery'}
${paymentMethod === 'momo' ? `MoMo Account Name: ${momoName}` : `Full Amount: E${total.toFixed(2)}`}
${paymentMethod === 'momo' ? `Date: ${payDate} ${payTime}` : ''}

üìç *STATUS: PENDING*
Thank you for your order!`;

                window.open(`https://wa.me/${YOUR_WHATSAPP_NUMBER}?text=` + encodeURIComponent(msg), "_blank");
            }
            
            form.reset();
            document.getElementById("qty").value = 1;
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payDate').value = today;
            document.getElementById('payTime').value = '12:00';
            selectPayment('momo');
            
            updatePrice();
            fullImg.style.display = "none";
            cutImg.style.display = "none";
            servicesDiv.style.display = "none";
            
            document.getElementById("rName").innerText = "Name: " + name;
            document.getElementById("rPhone").innerText = "Phone: " + phone;
            document.getElementById("rOrder").innerText = `Order: ${type === "full" ? "Full Chicken" : "Cut Pieces"} x ${qty} (${size}kg)`;
            document.getElementById("rDeposit").innerText = paymentMethod === 'momo' ? "Deposit: E50 (Refundable)" : "Payment: Cash on Delivery";
            document.getElementById("rTotal").innerText = "Total Price: E" + total.toFixed(2);
            document.getElementById("rPayment").innerHTML = `<strong>Payment Method:</strong> ${paymentMethod === 'momo' ? 'MoMo' : 'Cash on Delivery'}`;
            document.getElementById("rMomoName").innerHTML = paymentMethod === 'momo' ? `<strong>MoMo Name:</strong> ${momoName}` : '';
            document.getElementById("rTracking").innerHTML = `<strong>Tracking #:</strong> ${trackingNumber}<br><strong>Status:</strong> PENDING`;
            receipt.style.display = "block";
            
        }).catch(error => {
            const offlineOrders = JSON.parse(localStorage.getItem('offlineOrders') || '[]');
            offlineOrders.push(order);
            localStorage.setItem('offlineOrders', JSON.stringify(offlineOrders));
            
            Swal.fire({
                icon: 'warning',
                title: 'Order Saved Offline',
                text: 'You are offline. Order will be synced when online.'
            });
        });
    });
});

// ============ PUBLIC REVIEWS - NO REVENUE DATA, ONLY RATINGS AND COMMENTS ============
function loadPublicReviews(filter = 'all') {
    db.ref("orders").orderByChild("rating").startAt(1).once("value", snap => {
        let html = '<h4>‚≠ê Customer Ratings & Reviews</h4>';
        let reviews = [];
        
        snap.forEach(s => {
            const order = s.val();
            if (order.rating && order.review) {
                reviews.push({
                    name: order.name,
                    rating: order.rating,
                    review: order.review,
                    date: order.ratedAt || order.timestamp
                });
            }
        });
        
        // Filter
        if (filter === 'high') {
            reviews = reviews.filter(r => r.rating >= 4);
        } else if (filter === 'low') {
            reviews = reviews.filter(r => r.rating <= 3);
        }
        
        // Sort by newest first
        reviews.sort((a, b) => b.date.localeCompare(a.date));
        
        if (reviews.length === 0) {
            html += '<p style="text-align:center; padding:20px;">No reviews yet</p>';
        } else {
            reviews.forEach(r => {
                html += `<div class="customer-card">
                            <div style="display:flex; justify-content:space-between;">
                                <h4 style="margin:0;">üë§ ${r.name}</h4>
                                <span class="rating-display">${'‚òÖ'.repeat(r.rating)}${'‚òÜ'.repeat(5-r.rating)}</span>
                            </div>
                            <p style="margin-top:10px;"><em>"${r.review}"</em></p>
                            <p><small>${new Date(r.date).toLocaleDateString()}</small></p>
                        </div>`;
            });
        }
        
        document.getElementById('publicReviewsList').innerHTML = html;
    });
}

// ============ CONFIRM DELIVERY ============
function showConfirmDelivery(orderId, order) {
    document.getElementById('confirmModal').style.display = 'flex';
    document.getElementById('confirmOrderDetails').innerHTML = `
        <p><strong>Order #${order.trackingNumber || orderId.slice(-6)}</strong></p>
        <p>${order.qty}x ${order.size}kg Chicken</p>
        <p>Total: E${order.total}</p>
    `;
    window.currentConfirmOrderId = orderId;
}

function confirmDelivery() {
    const orderId = window.currentConfirmOrderId;
    
    db.ref("orders/" + orderId).update({
        status: 'delivered',
        confirmed: true,
        confirmedAt: new Date().toISOString()
    }).then(() => {
        Swal.fire({
            icon: 'success',
            title: 'Order Confirmed!',
            text: 'Thank you for your purchase! Please rate your order.',
            confirmButtonText: '‚≠ê Rate Now'
        }).then(() => {
            closeConfirmModal();
            loadOrdersForRating();
        });
    });
}

function closeConfirmModal() {
    document.getElementById('confirmModal').style.display = 'none';
}

// ============ RATING SYSTEM ============
function loadOrdersForRating(phone = null) {
    const searchPhone = phone || document.getElementById('ratePhone').value;
    
    if (!searchPhone) {
        Swal.fire('Error', 'Please enter your phone number', 'error');
        return;
    }
    
    db.ref("orders").orderByChild("phone").equalTo(searchPhone).once("value", snap => {
        let html = '';
        
        if (!snap.exists()) {
            html = '<p style="text-align:center; color:#f44336;">No orders found with this phone number</p>';
        } else {
            snap.forEach(orderSnap => {
                const order = orderSnap.val();
                const orderId = orderSnap.key;
                
                html += `<div class="order-card">
                            <h4>üì¶ Order #${order.trackingNumber || orderId.slice(-6)}</h4>
                            <p><strong>Date:</strong> ${new Date(order.timestamp).toLocaleDateString()}</p>
                            <p><strong>Items:</strong> ${order.qty}x ${order.size}kg Chicken</p>
                            <p><strong>Status:</strong> <span class="status-${order.status || 'pending'}">${order.status || 'pending'}</span></p>`;
                
                if (order.status === 'delivered') {
                    if (order.rating) {
                        html += `<p><strong>Your Rating:</strong> <span class="rating-display">${'‚òÖ'.repeat(order.rating)}${'‚òÜ'.repeat(5-order.rating)}</span></p>
                                <p><strong>Review:</strong> ${order.review || 'No comment'}</p>`;
                    } else {
                        html += `<button onclick="openRatingModal('${orderId}')" class="btn-warning">‚≠ê Rate This Order</button>`;
                    }
                } else if (order.status === 'ready') {
                    html += `<button onclick="showConfirmDelivery('${orderId}', ${JSON.stringify(order).replace(/"/g, '&quot;')})" class="btn-success">‚úÖ Confirm Delivery</button>`;
                }
                
                html += `</div>`;
            });
        }
        
        document.getElementById('ordersForRating').innerHTML = html;
    });
}

function openRatingModal(orderId) {
    document.getElementById('ratingModal').style.display = 'flex';
    window.currentRatingOrderId = orderId;
    
    db.ref("orders/" + orderId).once("value", snap => {
        const order = snap.val();
        document.getElementById('ratingOrderDetails').innerHTML = `
            <p><strong>Order #${order.trackingNumber || orderId.slice(-6)}</strong></p>
            <p>${order.qty}x ${order.size}kg Chicken</p>
            <p>Total: E${order.total}</p>
        `;
    });
}

function closeRatingModal() {
    document.getElementById('ratingModal').style.display = 'none';
    document.querySelectorAll('input[name="rating"]').forEach(r => r.checked = false);
    document.getElementById('reviewComment').value = '';
}

function submitRating() {
    const rating = document.querySelector('input[name="rating"]:checked')?.value;
    const comment = document.getElementById('reviewComment').value;
    const orderId = window.currentRatingOrderId;
    
    if (!rating) {
        Swal.fire('Error', 'Please select a rating', 'error');
        return;
    }
    
    db.ref("orders/" + orderId).update({
        rating: parseInt(rating),
        review: comment,
        ratedAt: new Date().toISOString()
    }).then(() => {
        Swal.fire('Success', 'Thank you for your review!', 'success');
        closeRatingModal();
        loadOrdersForRating();
    });
}

// ============ TRACKING ============
function trackOrder() {
    const phone = document.getElementById('trackPhone').value;
    
    if (!phone) {
        Swal.fire('Error', 'Please enter your phone number', 'error');
        return;
    }
    
    db.ref("orders").orderByChild("phone").equalTo(phone).once("value", snap => {
        let html = '';
        
        if (!snap.exists()) {
            html = '<p style="text-align:center; color:#f44336;">No orders found with this phone number</p>';
        } else {
            snap.forEach(orderSnap => {
                const order = orderSnap.val();
                const orderId = orderSnap.key;
                
                const statuses = ['pending', 'processing', 'ready', 'delivered'];
                const statusNames = {
                    'pending': 'Order Received',
                    'processing': 'Processing',
                    'ready': 'Ready for Delivery',
                    'delivered': 'Delivered'
                };
                
                let currentStep = statuses.indexOf(order.status || 'pending');
                if (currentStep === -1) currentStep = 0;
                
                let stepsHtml = '';
                statuses.forEach((status, index) => {
                    let stepClass = '';
                    let icon = '';
                    
                    if (index < currentStep) {
                        stepClass = 'step-completed';
                        icon = '‚úÖ';
                    } else if (index === currentStep) {
                        stepClass = 'step-active';
                        icon = '‚è≥';
                    } else {
                        stepClass = '';
                        icon = '‚≠ï';
                    }
                    
                    stepsHtml += `<div class="tracking-step ${stepClass}">
                                    <div class="step-icon">${icon}</div>
                                    <div class="step-content">
                                        <strong>${statusNames[status]}</strong><br>
                                        ${order.statusHistory && order.statusHistory[index] ? 
                                          new Date(order.statusHistory[index].timestamp).toLocaleString() : ''}
                                    </div>
                                </div>`;
                });
                
                html += `<div class="order-card">
                            <h4>üì¶ Order #${order.trackingNumber || orderId.slice(-6)}</h4>
                            <p><strong>Date:</strong> ${new Date(order.timestamp).toLocaleDateString()}</p>
                            <p><strong>Items:</strong> ${order.qty}x ${order.size}kg Chicken (${order.type === 'full' ? 'Full' : 'Cut'})</p>
                            <p><strong>Total:</strong> E${order.total}</p>
                            <p><strong>Payment:</strong> ${order.paymentMethod === 'momo' ? 'MoMo' : 'Cash on Delivery'}</p>
                            <p><strong>Status:</strong> <span class="status-${order.status || 'pending'}">${statusNames[order.status || 'pending']}</span></p>
                            <div style="margin-top:15px;">
                                ${stepsHtml}
                            </div>`;
                
                if (order.status === 'delivered' && !order.confirmed) {
                    html += `<button onclick="showConfirmDelivery('${orderId}', ${JSON.stringify(order).replace(/"/g, '&quot;')})" class="btn-success">‚úÖ Confirm Delivery</button>`;
                }
                
                if (order.status === 'delivered' && !order.rating) {
                    html += `<button onclick="openRatingModal('${orderId}')" class="btn-warning" style="margin-top:10px;">‚≠ê Rate This Order</button>`;
                }
                
                if (order.rating) {
                    html += `<p style="margin-top:10px;"><strong>Your Rating:</strong> <span class="rating-display">${'‚òÖ'.repeat(order.rating)}${'‚òÜ'.repeat(5-order.rating)}</span></p>
                            <p><strong>Review:</strong> ${order.review || 'No comment'}</p>`;
                }
                
                html += `</div>`;
            });
        }
        
        document.getElementById('trackingResult').innerHTML = html;
    });
}

// ============ ADMIN ONLY FUNCTIONS - CUSTOMERS, ORDERS, STATS ============
function loadCustomerStats() {
    db.ref("customers").once("value", snap => {
        let totalCustomers = 0;
        let totalOrders = 0;
        let totalRevenue = 0;
        
        snap.forEach(c => {
            const customer = c.val();
            totalCustomers++;
            totalOrders += customer.orders || 0;
            totalRevenue += parseFloat(customer.totalSpent || 0);
        });
        
        document.getElementById('customerStats').innerHTML = `
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div style="background:white; padding:15px; border-radius:10px; text-align:center;">
                    <h3 style="margin:0; color:#2196f3;">${totalCustomers}</h3>
                    <small>Total Customers</small>
                </div>
                <div style="background:white; padding:15px; border-radius:10px; text-align:center;">
                    <h3 style="margin:0; color:#4caf50;">${totalOrders}</h3>
                    <small>Total Orders</small>
                </div>
                <div style="background:white; padding:15px; border-radius:10px; text-align:center; grid-column:span 2;">
                    <h3 style="margin:0; color:#ff9800;">E${totalRevenue.toFixed(2)}</h3>
                    <small>Total Revenue</small>
                </div>
            </div>
        `;
    });
}

function loadAllOrders() {
    db.ref("orders").orderByChild("timestamp").on("value", snap => {
        let html = '';
        let count = 0;
        
        if (!snap.exists()) {
            html = '<p style="text-align:center;">No orders yet</p>';
        } else {
            const orders = [];
            snap.forEach(s => {
                orders.push({ key: s.key, ...s.val() });
            });
            
            orders.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
            
            orders.forEach(order => {
                count++;
                const statusColors = {
                    'pending': '#ff9800',
                    'processing': '#2196f3',
                    'ready': '#4caf50',
                    'delivered': '#9c27b0'
                };
                
                html += `<div style="border:1px solid #ddd; border-left:5px solid ${statusColors[order.status || 'pending']}; border-radius:10px; padding:15px; margin-bottom:15px; background:white;">
                            <div style="display:flex; justify-content:space-between;">
                                <h4 style="margin:0;">#${order.trackingNumber || order.key.slice(-6)}</h4>
                                <span style="background:${statusColors[order.status || 'pending']}; color:white; padding:5px 10px; border-radius:20px; font-size:12px;">
                                    ${(order.status || 'pending').toUpperCase()}
                                </span>
                            </div>
                            <p><strong>üë§ ${order.name}</strong> - üìû ${order.phone}</p>
                            <p>üì¶ ${order.qty}x ${order.size}kg Chicken (${order.type}) - Total: E${order.total}</p>
                            <p>üìç ${order.address}</p>
                            <p><strong>üí≥ Payment:</strong> ${order.paymentMethod === 'momo' ? 'MoMo' : 'Cash on Delivery'}</p>
                            ${order.momoName ? `<p><strong>MoMo Name:</strong> ${order.momoName}</p>` : ''}`;
                
                if (order.rating) {
                    html += `<p><strong>‚≠ê Rating:</strong> ${'‚òÖ'.repeat(order.rating)}${'‚òÜ'.repeat(5-order.rating)} - ${order.review || 'No comment'}</p>`;
                }
                
                html += `<div style="display:flex; gap:5px; margin-top:10px;">
                                <button onclick="updateOrderStatus('${order.key}', 'processing')" class="btn-info" style="flex:1; margin:0; padding:8px;">‚öôÔ∏è Process</button>
                                <button onclick="updateOrderStatus('${order.key}', 'ready')" class="btn-success" style="flex:1; margin:0; padding:8px;">‚úÖ Ready</button>
                                <button onclick="updateOrderStatus('${order.key}', 'delivered')" class="btn-warning" style="flex:1; margin:0; padding:8px;">üöö Delivered</button>
                                <button onclick="deleteOrder('${order.key}')" class="btn-danger" style="flex:1; margin:0; padding:8px;">üóëÔ∏è Delete</button>
                            </div>
                        </div>`;
            });
        }
        
        html = `<p><strong>Total Orders: ${count}</strong></p>` + html;
        document.getElementById('ordersList').innerHTML = html;
    });
}

function updateOrderStatus(orderId, newStatus) {
    const statusNames = {
        'pending': 'Order Received',
        'processing': 'Processing',
        'ready': 'Ready for Delivery',
        'delivered': 'Delivered'
    };
    
    db.ref("orders/" + orderId).once("value", snap => {
        const order = snap.val();
        const history = order.statusHistory || [];
        
        history.push({
            status: newStatus,
            timestamp: new Date().toISOString(),
            note: `Status changed to ${statusNames[newStatus]}`
        });
        
        db.ref("orders/" + orderId).update({
            status: newStatus,
            statusHistory: history,
            lastUpdated: new Date().toISOString()
        }).then(() => {
            Swal.fire('Success', `Order status updated to ${statusNames[newStatus]}`, 'success');
        });
    });
}

function deleteOrder(orderId) {
    Swal.fire({
        title: 'Delete Order?',
        text: "This cannot be undone!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#f44336',
        confirmButtonText: 'Delete'
    }).then((result) => {
        if (result.isConfirmed) {
            db.ref("orders/" + orderId).remove().then(() => {
                Swal.fire('Deleted!', 'Order has been removed.', 'success');
            });
        }
    });
}

// ============ EXPORT FUNCTIONS - ADMIN ONLY ============
function exportCustomers() {
    db.ref("customers").once("value", snap => {
        const customers = [];
        snap.forEach(s => {
            customers.push({ id: s.key, ...s.val() });
        });
        
        let csv = "Phone,Name,ID Number,Address,Orders,Total Spent,First Order,Last Order\n";
        
        customers.forEach(c => {
            csv += `${c.phone},${c.name},${c.idNumber},${c.address},${c.orders},${c.totalSpent},${c.firstOrder},${c.lastOrder}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'lusungulo_customers.csv';
        a.click();
    });
}

function exportOrders() {
    db.ref("orders").once("value", snap => {
        const orders = [];
        snap.forEach(s => {
            orders.push({ id: s.key, ...s.val() });
        });
        
        let csv = "Order ID,Date,Tracking#,Name,Phone,Size,Qty,Type,Service,Payment Method,MoMo Name,Total,Status,Rating,Review,Address\n";
        
        orders.forEach(o => {
            csv += `${o.id},${o.timestamp},${o.trackingNumber || ''},${o.name},${o.phone},${o.size},${o.qty},${o.type},${o.service || 0},${o.paymentMethod},${o.momoName || ''},${o.total},${o.status || 'pending'},${o.rating || ''},${o.review || ''},${o.address}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'lusungulo_orders.csv';
        a.click();
    });
}

function exportRatings() {
    db.ref("orders").orderByChild("rating").startAt(1).once("value", snap => {
        const ratings = [];
        snap.forEach(s => {
            const o = s.val();
            if (o.rating) {
                ratings.push({
                    id: s.key,
                    name: o.name,
                    phone: o.phone,
                    rating: o.rating,
                    review: o.review || '',
                    date: o.ratedAt || o.timestamp
                });
            }
        });
        
        let csv = "Order ID,Customer Name,Phone,Rating,Review,Date\n";
        
        ratings.forEach(r => {
            csv += `${r.id},${r.name},${r.phone},${r.rating},${r.review},${r.date}\n`;
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'lusungulo_ratings.csv';
        a.click();
    });
}

// ============ INITIALIZATION ============
window.onload = function() {
    updatePrice();
    displayStock();
    selectPayment('momo');
    updateOnlineStatus();
    loadPublicReviews('all');
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('payDate').value = today;
    document.getElementById('payTime').value = '12:00';
    
    // Sync offline orders
    if (navigator.onLine) {
        const offlineOrders = JSON.parse(localStorage.getItem('offlineOrders') || '[]');
        if (offlineOrders.length > 0) {
            offlineOrders.forEach(order => {
                db.ref("orders").push(order);
            });
            localStorage.removeItem('offlineOrders');
            Swal.fire('Synced!', `${offlineOrders.length} offline orders synced`, 'success');
        }
    }
};
</script>
</body>
</html>
